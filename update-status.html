<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>üì¶ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/feather-icons"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/th.js"></script>
    <style>
      body {
        font-family: "Prompt", sans-serif;
        background: #f3f4f6;
        margin: 0;
        padding: 10px;
        padding-bottom: 80px;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        min-height: 100vh;
      }

      .box {
        width: 100%;
        max-width: 540px;
        background: #fff;
        padding: 15px 20px;
        border-radius: 16px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        box-sizing: border-box;
      }

      h1 {
        font-size: 20px;
        margin-bottom: 10px;
        text-align: center;
        color: #1f2937;
      }

      #orderInfo {
        text-align: center;
        color: #6b7280;
        margin-bottom: 15px;
        font-size: 13px;
      }

      .order-badge {
        display: inline-block;
        background: #dbeafe;
        color: #1e40af;
        padding: 5px 12px;
        border-radius: 8px;
        margin-top: 5px;
        font-weight: 500;
      }

      .result-section {
        background: #f9fafb;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        padding: 12px;
        margin-bottom: 12px;
        display: none; /* ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏•‡∏≥‡∏î‡∏±‡∏ö */
      }

      .result-section h3 {
        margin: 0 0 10px 0;
        color: #374151;
        font-size: 15px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .result-section.active {
        border-color: #3b82f6;
        background: #eff6ff;
      }

      label {
        display: block;
        margin: 8px 0 4px;
        font-weight: 500;
        color: #374151;
        font-size: 13px;
      }

      select,
      input,
      textarea {
        width: 100%;
        padding: 8px 11px;
        border: 1px solid #d1d5db;
        border-radius: 10px;
        font-family: inherit;
        font-size: 14px;
        box-sizing: border-box;
        transition: all 0.2s ease;
      }

      textarea {
        resize: vertical;
        min-height: 60px;
      }

      select:focus,
      input:focus,
      textarea:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 2px #93c5fd;
      }

      input[readonly] {
        background: #f3f4f6;
        cursor: not-allowed;
      }

      #submitBtn {
        margin-top: 10px;
        padding: 12px 20px;
        border: none;
        background: #2563eb;
        color: white;
        border-radius: 10px;
        cursor: pointer;
        width: 100%;
        font-size: 15px;
        font-weight: 600;
        transition: all 0.25s ease;
      }

      #submitBtn:hover {
        background: #1d4ed8;
        transform: translateY(-1px);
      }

      #submitBtn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
      }

      #resultMsg {
        text-align: center;
        margin-top: 18px;
        font-weight: 500;
        padding: 12px;
        border-radius: 10px;
        display: none;
      }

      #resultMsg.show {
        display: block;
      }

      #resultMsg.success {
        background: #d1fae5;
        color: #065f46;
      }

      #resultMsg.error {
        background: #fee2e2;
        color: #991b1b;
      }

      #resultMsg.loading {
        background: #dbeafe;
        color: #1e40af;
      }

      .summary-card {
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        margin-bottom: 20px;
        display: none;
      }

      .summary-card.success {
        display: block;
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #10b981;
      }

      .summary-card.error {
        display: block;
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #f87171;
      }

      .summary-card i {
        width: 48px;
        height: 48px;
        margin-bottom: 10px;
      }

      .summary-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 5px;
      }

      .summary-detail {
        font-size: 14px;
        opacity: 0.9;
      }

      #fetch-loading {
        text-align: center;
        padding: 20px;
        display: none;
      }

      .result-section {
        display: none; /* ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏•‡∏≥‡∏î‡∏±‡∏ö */
      }

      @media (max-width: 480px) {
        body {
          padding: 10px;
          padding-bottom: 90px;
        }

        .box {
          padding: 20px;
          border-radius: 12px;
        }

        h1 {
          font-size: 20px;
        }
      }

      .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #1e3a8a;
        display: flex;
        justify-content: space-around;
        align-items: center;
        padding: 12px 0;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        z-index: 1000;
      }

      .nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        color: rgba(255, 255, 255, 0.7);
        text-decoration: none;
        font-size: 12px;
        transition: all 0.2s ease;
        background: none;
        border: none;
        cursor: pointer;
        font-family: "Prompt", sans-serif;
      }

      .nav-item.active {
        color: #ffffff;
      }

      .nav-item i {
        margin-bottom: 4px;
        width: 20px;
        height: 20px;
      }

      /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Date Picker */
      .date-reschedule-container {
        display: none;
        margin-top: 10px;
        padding: 10px;
        background: #fff;
        border: 1px dashed #3b82f6;
        border-radius: 10px;
      }

      .date-reschedule-container label {
        color: #1e40af;
        margin-top: 0;
      }
    </style>
    <script>
      // Protect Route
      const token = localStorage.getItem("tn_employee_token");
      if (!token) {
        window.location.href = "login_employee.html";
      }
    </script>
  </head>

  <body>
    <div class="box">
      <h1>üì¶ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô</h1>

      <!-- UI ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• -->
      <div id="summary-container"></div>

      <div id="fetch-loading">
        <i data-feather="loader" class="spin" style="color: #2563eb"></i>
        <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô...</p>
      </div>

      <form id="updateForm" style="display: none">
        <label>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô</label>
        <input
          type="text"
          name="orderNo"
          id="orderNoInput"
          placeholder="‡πÄ‡∏ä‡πà‡∏ô 0001"
          required
        /><br />

        <div class="input-group">
          <label for="messengerName">üë§ ‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πà‡∏á‡∏á‡∏≤‡∏ô)</label>
          <input
            type="text"
            name="messengerName"
            id="messengerName"
            placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô"
            required
          />
        </div>
        <br />

        <div class="result-section" id="section1">
          <h3>üöö ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πà‡∏á‡∏á‡∏≤‡∏ô 1</h3>
          <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
          <select name="result1" id="result1" onchange="togglePostponeDate(1)">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ --</option>
            <option>‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option>
            <option>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô</option>
            <option>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏¢</option>
            <option>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô</option>
            <option>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
            <option>‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏ã‡πâ‡∏≥</option>
          </select>

          <div id="date-postpone-container-1" class="date-reschedule-container">
            <label>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <input type="text" id="rescheduledDate1" name="rescheduledDate1" placeholder="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà">
          </div>

          <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
          <textarea
            name="note1"
            id="note1"
            placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."
          ></textarea>
        </div>

        <div class="result-section" id="section2">
          <h3>üöö ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πà‡∏á‡∏á‡∏≤‡∏ô 2</h3>
          <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
          <select name="result2" id="result2" onchange="togglePostponeDate(2)">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ --</option>
            <option>‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option>
            <option>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô</option>
            <option>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏¢</option>
            <option>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô</option>
            <option>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
            <option>‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏ã‡πâ‡∏≥</option>
          </select>

          <div id="date-postpone-container-2" class="date-reschedule-container">
            <label>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <input type="text" id="rescheduledDate2" name="rescheduledDate2" placeholder="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà">
          </div>

          <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
          <textarea
            name="note2"
            id="note2"
            placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."
          ></textarea>
        </div>

        <div class="result-section" id="section3">
          <h3>üöö ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πà‡∏á‡∏á‡∏≤‡∏ô 3</h3>
          <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
          <select name="result3" id="result3" onchange="togglePostponeDate(3)">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ --</option>
            <option>‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option>
            <option>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô</option>
            <option>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏¢</option>
            <option>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô</option>
            <option>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
            <option>‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏ã‡πâ‡∏≥</option>
          </select>

          <div id="date-postpone-container-3" class="date-reschedule-container">
            <label>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <input type="text" id="rescheduledDate3" name="rescheduledDate3" placeholder="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà">
          </div>

          <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
          <textarea
            name="note3"
            id="note3"
            placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."
          ></textarea>
        </div>

        <button type="submit" id="submitBtn">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button>
      </form>

      <div id="resultMsg"></div>
    </div>

    <nav class="bottom-nav">
      <a href="home.html" class="nav-item">
        <i data-feather="home"></i>
        <span>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
      </a>
      <a href="scan.html" class="nav-item">
        <i data-feather="maximize"></i>
        <span>‡∏™‡πÅ‡∏Å‡∏ô</span>
      </a>
      <a href="list.html" class="nav-item">
        <i data-feather="list"></i>
        <span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
      </a>
      <button onclick="handleLogout()" class="nav-item" style="color: #fda4af">
        <i data-feather="log-out"></i>
        <span>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span>
      </button>
    </nav>

    <script>
      // üí°üö® ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏ô‡∏≥ URL Deployment ‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å Apps Script ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
      const SCRIPT_URL =
        "https://script.google.com/macros/s/AKfycbwutGjM8fg__QRCBYBiDsCJ8ttkQ-97v8gER_C_W7VB4TG5-vvX5doUXlbGc5bvZYM5/exec";

      const urlParams = new URLSearchParams(window.location.search);
      const orderFromURL = urlParams.get("order");

      const orderInput = document.getElementById("orderNoInput");
      const messengerNameInput = document.getElementById("messengerName"); // ‚úÖ ‡∏≠‡πà‡∏≤‡∏ô element ‡πÉ‡∏´‡∏°‡πà
      const orderInfo = document.getElementById("orderInfo");
      const resultMsg = document.getElementById("resultMsg");
      const submitBtn = document.getElementById("submitBtn");

      // ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å localStorage
      const userData = JSON.parse(
        localStorage.getItem("tn_employee_user") || "{}"
      );
      if (userData.username) {
        messengerNameInput.value = userData.username;
        messengerNameInput.setAttribute("readonly", true); // ‡∏•‡πá‡∏≠‡∏Ñ‡πÑ‡∏ß‡πâ‡πÄ‡∏•‡∏¢‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      }

      // ‚úÖ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å QR Code
      if (orderFromURL) {
        orderInput.value = orderFromURL;
        orderInput.setAttribute("readonly", true);
        fetchTaskData(orderFromURL); // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      } else {
        orderInfo.textContent = "‚öôÔ∏è ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞";
        document.getElementById("updateForm").style.display = "block"; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ß‡πà‡∏≤‡∏á‡πÜ
      }

      // ‡∏ü‡∏±‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÉ‡∏ô input ‡∏ñ‡πâ‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏°‡∏∑‡∏≠
      orderInput.addEventListener("change", (e) => {
        if (e.target.value.trim()) {
          fetchTaskData(e.target.value.trim());
        }
      });

      async function fetchTaskData(orderNo) {
        orderNo = orderNo.toString().replace(/^0+/, ""); // ‡∏ï‡∏±‡∏î‡πÄ‡∏•‡∏Ç 0 ‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏≠‡∏Å (‡πÄ‡∏ä‡πà‡∏ô 0391 -> 391)
        const loading = document.getElementById("fetch-loading");
        const form = document.getElementById("updateForm");
        const summaryContainer = document.getElementById("summary-container");

        loading.style.display = "block";
        form.style.display = "none";
        summaryContainer.innerHTML = "";

        const callbackName = "getTask_" + Date.now();
        window[callbackName] = function (response) {
          console.log("API Response:", response);
          loading.style.display = "none";
          delete window[callbackName];
          document.body.removeChild(script);

          if (response.result === "success" && response.data) {
            processTaskData(response.data);
          } else {
            form.style.display = "block"; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
          }
        };

        const script = document.createElement("script");
        script.src = `${SCRIPT_URL}?callback=${callbackName}&action=get_task_by_id&data=${encodeURIComponent(
          JSON.stringify({ orderNo })
        )}`;
        document.body.appendChild(script);
      }

      function processTaskData(data) {
        const form = document.getElementById("updateForm");
        const summaryContainer = document.getElementById("summary-container");
        const submitBtn = document.getElementById("submitBtn");

        const s1 = data["‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πà‡∏á‡∏á‡∏≤‡∏ô 1: ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞"];
        const s2 = data["‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πà‡∏á‡∏á‡∏≤‡∏ô 2: ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞"];
        const s3 = data["‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πà‡∏á‡∏á‡∏≤‡∏ô 3: ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞"];

        const isFinished = (s) => s === "‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à" || s === "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å";

        // 1. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏ö‡∏á‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
        if (isFinished(s1) || isFinished(s2) || isFinished(s3)) {
          const finalStatus = isFinished(s1) ? s1 : isFinished(s2) ? s2 : s3;
          const isSuccess = finalStatus === "‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";

          summaryContainer.innerHTML = `
            <div class="summary-card ${isSuccess ? "success" : "error"}">
              <i data-feather="${isSuccess ? "check-circle" : "x-circle"}"></i>
              <div class="summary-title">‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ ${finalStatus} ‡πÅ‡∏•‡πâ‡∏ß</div>
              <div class="summary-detail">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å</div>
            </div>
          `;
          feather.replace();
          form.style.display = "none";
          return;
        }

        // 2. ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏á‡∏≤‡∏ô ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå Section ‡πÑ‡∏´‡∏ô
        form.style.display = "block";
        const sections = [
          document.getElementById("section1"),
          document.getElementById("section2"),
          document.getElementById("section3"),
        ];

        // ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏≠‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô
        sections.forEach((s) => (s.style.display = "none"));

        if (!s1) {
          sections[0].style.display = "block";
        } else if (!s2) {
          sections[1].style.display = "block";
        } else if (!s3) {
          sections[2].style.display = "block";
        } else {
          // ‡πÄ‡∏ï‡πá‡∏° 3 ‡∏£‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à/‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
          summaryContainer.innerHTML = `
            <div class="summary-card error">
              <i data-feather="alert-triangle"></i>
              <div class="summary-title">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏£‡∏ö 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß</div>
              <div class="summary-detail">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${s3} (‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ)</div>
            </div>
          `;
          feather.replace();
          form.style.display = "none";
          return;
        }
      }

      // ‚úÖ Highlight section ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      ["result1", "result2", "result3"].forEach((id, index) => {
        document.getElementById(id).addEventListener("focus", () => {
          document
            .getElementById(`section${index + 1}`)
            .classList.add("active");
        });
        document.getElementById(id).addEventListener("blur", () => {
          document
            .getElementById(`section${index + 1}`)
            .classList.remove("active");
        });
      });

      function showResult(type, message) {
        resultMsg.className = type + " show";
        resultMsg.textContent = message;

        if (type === "success") {
          setTimeout(() => {
            if (!orderFromURL) {
              document.getElementById("updateForm").reset();
              orderInput.focus();
            } else {
              // ‡∏ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å URL ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á reset orderNo ‡πÅ‡∏ï‡πà‡πÉ‡∏´‡πâ reset ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏ó‡∏ô
              document.getElementById("result1").value = "";
              document.getElementById("note1").value = "";
              document.getElementById("result2").value = "";
              document.getElementById("note2").value = "";
              document.getElementById("result3").value = "";
              document.getElementById("note3").value = "";
            }
            resultMsg.className = "";
          }, 3000);
        }
      }

      document
        .getElementById("updateForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const formData = new FormData(e.target);
          const orderNo = formData.get("orderNo").trim();
          const messengerName = formData.get("messengerName").trim(); // ‚úÖ ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
          const result1 = formData.get("result1");
          const note1 = formData.get("note1").trim();
          const result2 = formData.get("result2");
          const note2 = formData.get("note2").trim();
          const result3 = formData.get("result3");
          const note3 = formData.get("note3").trim();

          if (!orderNo)
            return showResult("error", "‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô");
          if (!messengerName)
            return showResult("error", "‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô"); // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô

          submitBtn.disabled = true;
          submitBtn.textContent = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
          showResult("loading", "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞...");

          // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö dd/mm/yyyy
          const now = new Date();
          const autoDate = `${now.getDate().toString().padStart(2, "0")}/${(
            now.getMonth() + 1
          )
            .toString()
            .padStart(2, "0")}/${now.getFullYear()}`;

          // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
          const isPostpone = (val) => val === "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô" || val === "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô";

          const payload = {
            action: "update",
            orderNo,
            messengerName, // ‚úÖ ‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô payload
            id: userData.id || "", // ‚úÖ ‡πÉ‡∏™‡πà id ‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
            result1: result1 || "",
            date1: result1 ? (isPostpone(result1) ? formData.get("rescheduledDate1") : autoDate) : "",
            note1: note1 || "",
            result2: result2 || "",
            date2: result2 ? (isPostpone(result2) ? formData.get("rescheduledDate2") : autoDate) : "",
            note2: note2 || "",
            result3: result3 || "",
            date3: result3 ? (isPostpone(result3) ? formData.get("rescheduledDate3") : autoDate) : "",
            note3: note3 || "",
            timestamp: new Date().toLocaleString("th-TH"),
          };

          try {
            const callbackName = "callback_" + Date.now();
            window[callbackName] = function (response) {
              submitBtn.disabled = false;
              submitBtn.textContent = "üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞";

              if (response && response.result === "success") {
                showResult("success", "‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
              } else {
                showResult(
                  "error",
                  "‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " +
                    (response.message || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏î‡πâ")
                );
              }

              delete window[callbackName];
              document.body.removeChild(script);
            };

            // ‚úÖ ‡∏™‡πà‡∏á action=update ‡πÅ‡∏•‡∏∞ data ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Apps Script
            const script = document.createElement("script");
            script.src = `${SCRIPT_URL}?callback=${callbackName}&action=update&data=${encodeURIComponent(
              JSON.stringify(payload)
            )}`;
            script.onerror = function () {
              submitBtn.disabled = false;
              submitBtn.textContent = "üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞";
              showResult("error", "‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ");
              delete window[callbackName];
            };
            document.body.appendChild(script);
          } catch (error) {
            submitBtn.disabled = false;
            submitBtn.textContent = "üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞";
            showResult("error", "‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
          }
        });

      if (orderFromURL) document.getElementById("result1").focus();
      else orderInput.focus();

      feather.replace();

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô
      function togglePostponeDate(index) {
        const select = document.getElementById(`result${index}`);
        const container = document.getElementById(`date-postpone-container-${index}`);
        const dateInput = document.getElementById(`rescheduledDate${index}`);

        if (select.value === "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô" || select.value === "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô") {
          container.style.display = "block";
          if (!dateInput._flatpickr) {
            flatpickr(dateInput, {
              locale: "th",
              altInput: true,
              altFormat: "d/m/Y",
              dateFormat: "d/m/Y",
              defaultDate: "today",
            });
          }
        } else {
          container.style.display = "none";
        }
      }

      function handleLogout() {
        if (confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
          localStorage.removeItem("tn_employee_token");
          localStorage.removeItem("tn_employee_user");
          window.location.href = "login_employee.html";
        }
      }
    </script>
  </body>
</html>
